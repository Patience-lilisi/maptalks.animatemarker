/*!
 * maptalks.animatemarker v0.1.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,t){"use strict";function r(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],a=Object.getOwnPropertyDescriptor(t,o);a&&a.configurable&&void 0===e[o]&&Object.defineProperty(e,o,a)}return e}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):r(e,t))}function i(e){return{type:"radial",colorStops:[[.7,"rgba("+e.join()+", 0.5)"],[.3,"rgba("+e.join()+", 1)"],[.2,"rgba("+e.join()+", 1)"],[0,"rgba("+e.join()+", 0)"]]}}function s(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}var p={markerType:"ellipse",markerFill:i([135,196,240]),markerFillOpacity:.8,markerLineWidth:0,markerWidth:16,markerHeight:16},c={animation:"scale,fade",randomAnimation:!0,animationDuration:3e3},h=function(e){function r(){return n(this,r),o(this,e.apply(this,arguments))}return a(r,e),r.prototype.addGeometry=function(r){return r instanceof t.Geometry&&(r=[r]),r.forEach(function(e,r){if(!(e instanceof t.Marker))throw new Error("The geometry at "+r+" to add is not a maptalks.Marker")}),e.prototype.addGeometry.apply(this,arguments)},r.fromJSON=function(e){if(!e||"AnimateMarkerLayer"!==e.type)return null;for(var n=new r(e.id,e.options),o=e.geometries,a=[],i=0;i<o.length;i++){var s=t.Geometry.fromJSON(o[i]);s&&a.push(s)}return n.addGeometry(a),e.style&&n.setStyle(e.style),n},r}(t.VectorLayer);h.mergeOptions(c),h.registerJSONType("AnimateMarkerLayer"),h.registerRenderer("canvas",function(e){function r(){return n(this,r),o(this,e.apply(this,arguments))}return a(r,e),r.prototype.draw=function(){this._needUpdate&&(this._prepare(),this._needUpdate=!1),this.prepareCanvas();var e=this.getMap(),t=this._currentMarkers;this._drawnExtent&&e.getExtent().equals(this._drawnExtent)&&(t=this._drawnMarkers),this._drawAllMarkers(t),this._drawnExtent=e.getExtent(),this.layer.isLoaded()||this.completeRender()},r.prototype.drawOnInteracting=function(){this._drawAllMarkers(this._drawnMarkers)},r.prototype.isAnimating=function(){return!0},r.prototype.onCanvasCreate=function(){this._prepare()},r.prototype.onGeometryAdd=function(){this._redraw()},r.prototype.onGeometryRemove=function(){this._redraw()},r.prototype.onGeometrySymbolChange=function(){this._redraw()},r.prototype.onGeometryPositionChange=function(){this._redraw()},r.prototype.onGeometryShow=function(){this._redraw()},r.prototype.onGeometryHide=function(){this._redraw()},r.prototype.onGeometryPropertiesChange=function(e){if(e&&this.layer.getStyle())for(var t=0;t<e.length;t++)this.layer._styleGeometry(e[t])},r.prototype._redraw=function(){delete this._drawnMarkers,delete this._drawnExtent,this._needUpdate=!0},r.prototype._drawAllMarkers=function(e){var t=this,r=this.getMap(),n=r.getContainerExtent(),o=this._drawnTime=Date.now(),a=this._drawnAnim=this._getAnimation(),i=e!==this._drawnMarkers;i&&(this._drawnMarkers=[]),e.forEach(function(e){if(!i){var s=r._prjToContainerPoint(e.coordinates);return void t._drawMarker(e,s,a,o)}if(e.g.isVisible()){var p=r._prjToContainerPoint(e.coordinates);n.contains(p)&&(t._drawMarker(e,p,a,o),t._drawnMarkers.push(e))}},this)},r.prototype._drawMarker=function(e,t,r,n){var o=this.layer.options.animationDuration,a=this.context,i=a.globalAlpha,s=(n-e.start)%o/o,p=r.fade&&s>=.5?2-2*s:1,c=r.scale?s:1,h=e.cacheKey,l=this._spriteCache[h],d=l.offset,y=l.canvas.width,f=l.canvas.height;l&&p>0&&(a.globalAlpha=i*p,a.drawImage(l.canvas,t.x+d.x-y*c/2,t.y+d.y-f*c/2,y*c,f*c),a.globalAlpha=i)},r.prototype._prepare=function(){var e=this,t=[],r={},n=this.getMap().getProjection();this.layer.forEach(function(o){e._currentGeo=o;var a=o._getInternalSymbol()===o.options.symbol?p:o._getInternalSymbol(),i=JSON.stringify(a);r[i]||(r[i]=a),t.push({coordinates:n.project(o.getCoordinates()),cacheKey:i,start:e.layer.options.randomAnimation?Math.random()*e.layer.options.animationDuration:0,g:o})}),this._prepareSprites(r),this._currentMarkers=t},r.prototype._prepareSprites=function(e){this._spriteCache={};for(var r in e){var n=e[r],o=new t.Marker([0,0],{symbol:n})._getSprite(this.resources);this._spriteCache[r]=o}},r.prototype.onRemove=function(){delete this._spriteCache,delete this._currentMarkers,delete this._drawnMarkers,delete this._drawnExtent},r.prototype._getAnimation=function(){for(var e={fade:!1,scale:!1},t=this.layer.options.animation?this.layer.options.animation.split(","):[],r=0;r<t.length;r++){var n=s(t[r]);"fade"===n?e.fade=!0:"scale"===n&&(e.scale=!0)}return e},r}(t.renderer.OverlayLayerCanvasRenderer)),e.AnimateMarkerLayer=h,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.animatemarker v0.1.2, requires maptalks@^0.23.0.")});