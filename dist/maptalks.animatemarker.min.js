/*!
 * maptalks.animatemarker v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function n(t,e){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var i=n[r],o=Object.getOwnPropertyDescriptor(e,i);o&&o.configurable&&void 0===t[i]&&Object.defineProperty(t,i,o)}return t}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):n(t,e))}function a(t){return{type:"radial",colorStops:[[.7,"rgba("+t.join()+", 0.5)"],[.3,"rgba("+t.join()+", 1)"],[.2,"rgba("+t.join()+", 1)"],[0,"rgba("+t.join()+", 0)"]]}}var s={markerType:"ellipse",markerFill:a([135,196,240]),markerFillOpacity:.8,markerLineWidth:0,markerWidth:16,markerHeight:16},p={animation:"scale,fade",animationOnce:!1,randomAnimation:!0,animationDuration:3e3,symbol:null,fps:24},h=function(t){function n(){return r(this,n),i(this,t.apply(this,arguments))}return o(n,t),n.prototype.addGeometry=function(n){return n instanceof e.Geometry&&(n=[n]),n.forEach(function(t,n){if(!(t instanceof e.Marker))throw new Error("The geometry at "+n+" to add is not a maptalks.Marker")}),t.prototype.addGeometry.apply(this,arguments)},n.fromJSON=function(t){if(!t||"AnimateMarkerLayer"!==t.type)return null;for(var r=new n(t.id,t.options),i=t.geometries,o=[],a=0;a<i.length;a++){var s=e.Geometry.fromJSON(i[a]);s&&o.push(s)}return r.addGeometry(o),t.style&&r.setStyle(t.style),r},n}(e.VectorLayer);h.mergeOptions(p),h.registerJSONType("AnimateMarkerLayer"),h.registerRenderer("canvas",function(t){function n(){return r(this,n),i(this,t.apply(this,arguments))}return o(n,t),n.prototype.draw=function(){this._animId&&this._cancelAnim(),this._needUpdate&&(this._prepare(),this._needUpdate=!1),this._animate(),this.isLoaded()||this.completeRender()},n.prototype.onCanvasCreate=function(){this._prepare()},n.prototype.onGeometryAdd=function(){this._redraw()},n.prototype.onGeometryRemove=function(){this._redraw()},n.prototype.onGeometrySymbolChange=function(){this._redraw()},n.prototype.onGeometryPositionChange=function(){this._redraw()},n.prototype.onGeometryShow=function(){this._redraw()},n.prototype.onGeometryHide=function(){this._redraw()},n.prototype.onGeometryPropertiesChange=function(t){if(t&&this.layer.getStyle())for(var e=0;e<t.length;e++)this.layer._styleGeometry(t[e])},n.prototype.hide=function(){return this._cancelAnim(),t.prototype.hide.call(this)},n.prototype._redraw=function(){this._cancelAnim(),this._needUpdate=!0,this.render()},n.prototype._animate=function(){var t=this;this.prepareCanvas(),this._drawMarkers();var n=e.Util.now();this._animFn||(this._animFn=function(){this._animate()}.bind(this),this._startTime=n);var r=this.layer.options;if(!(this.getMap()._zooming||this.getMap()._moving||r.animationOnce&&n-this._startTime>r.animationDuration)){var i=this.layer.options.fps||24;i>=62.5?this._animId=e.Util.requestAnimFrame(this._animFn):this._animTimeout=setTimeout(function(){e.Browser.ie9?t._animFn():t._animId=e.Util.requestAnimFrame(t._animFn)},1e3/this.layer.options.fps)}},n.prototype._drawMarkers=function(){var t=this.context,n=this.getMap(),r=n.getSize(),i=new e.PointExtent(0,0,r.width,r.height),o=this._extent2D.getMin(),a=this.layer.options.animationDuration,s=Date.now(),p=this._getAnimation(),h=t.globalAlpha;this._currentMarkers.forEach(function(e){if(e.g.isVisible()){var n=(s-e.start)%a/a,r=p.scale?n:1,c=e.point.substract(o);if(i.contains(c)){var l=p.fade&&n>=.5?2-2*n:1,m=e.cacheKey,y=this._spriteCache[m],f=y.offset,u=y.canvas.width,d=y.canvas.height;y&&l>0&&(t.globalAlpha=h*l,t.drawImage(y.canvas,c.x+f.x-u*r/2,c.y+f.y-d*r/2,u*r,d*r),t.globalAlpha=h)}}},this),this.requestMapToRender()},n.prototype._prepare=function(){var t=this,e=this.getMap(),n=[],r={};this.layer.forEach(function(i){t._currentGeo=i;var o=i._getInternalSymbol()===i.options.symbol?s:i._getInternalSymbol(),a=e.coordinateToPoint(i.getCoordinates()),p=JSON.stringify(o);r[p]||(r[p]=o),n.push({point:a,cacheKey:p,start:t.layer.options.randomAnimation?Math.random()*t.layer.options.animationDuration:0,g:i})}),this._prepareSprites(r),this._currentMarkers=n},n.prototype._prepareSprites=function(t){this._spriteCache={};for(var n in t){var r=t[n],i=new e.Marker([0,0],{symbol:r})._getSprite(this.resources);this._spriteCache[n]=i}},n.prototype._cancelAnim=function(){e.Util.cancelAnimFrame(this._animId),clearTimeout(this._animTimeout)},n.prototype.onZoomStart=function(){this._cancelAnim()},n.prototype.onZoomEnd=function(){this._prepare(),t.prototype.onZoomEnd.apply(this,arguments)},n.prototype.onRemove=function(){this._animId&&this._cancelAnim(),delete this._animFn,delete this._spriteCache,delete this._currentMarkers},n.prototype._getAnimation=function(){for(var t={fade:!1,scale:!1},n=this.layer.options.animation?this.layer.options.animation.split(","):[],r=0;r<n.length;r++){var i=e.StringUtil.trim(n[r]);"fade"===i?t.fade=!0:"scale"===i&&(t.scale=!0)}return t},n}(e.renderer.OverlayLayerCanvasRenderer)),t.AnimateMarkerLayer=h,Object.defineProperty(t,"__esModule",{value:!0})});