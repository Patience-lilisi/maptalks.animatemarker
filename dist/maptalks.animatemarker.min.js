/*!
 * maptalks.animatemarker v0.1.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),n=0;n<r.length;n++){var i=r[n],a=Object.getOwnPropertyDescriptor(e,i);a&&a.configurable&&void 0===t[i]&&Object.defineProperty(t,i,a)}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}function o(t){return{type:"radial",colorStops:[[.7,"rgba("+t.join()+", 0.5)"],[.3,"rgba("+t.join()+", 1)"],[.2,"rgba("+t.join()+", 1)"],[0,"rgba("+t.join()+", 0)"]]}}function s(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}var p={markerType:"ellipse",markerFill:o([135,196,240]),markerFillOpacity:.8,markerLineWidth:0,markerWidth:16,markerHeight:16},c={animation:"scale,fade",animationOnce:!1,randomAnimation:!0,animationDuration:3e3,fps:24},h=function(t){function r(){return n(this,r),i(this,t.apply(this,arguments))}return a(r,t),r.prototype.addGeometry=function(r){return r instanceof e.Geometry&&(r=[r]),r.forEach(function(t,r){if(!(t instanceof e.Marker))throw new Error("The geometry at "+r+" to add is not a maptalks.Marker")}),t.prototype.addGeometry.apply(this,arguments)},r.fromJSON=function(t){if(!t||"AnimateMarkerLayer"!==t.type)return null;for(var n=new r(t.id,t.options),i=t.geometries,a=[],o=0;o<i.length;o++){var s=e.Geometry.fromJSON(i[o]);s&&a.push(s)}return n.addGeometry(a),t.style&&n.setStyle(t.style),n},r}(e.VectorLayer);h.mergeOptions(c),h.registerJSONType("AnimateMarkerLayer"),h.registerRenderer("canvas",function(t){function r(){return n(this,r),i(this,t.apply(this,arguments))}return a(r,t),r.prototype.draw=function(){this._animId&&this._cancelAnim(),this._needUpdate&&(this._prepare(),this._needUpdate=!1),this._animate(),this.layer.isLoaded()||this.completeRender()},r.prototype.drawOnInteracting=function(){this._drawAllMarkers(this._drawnMarkers)},r.prototype.onCanvasCreate=function(){this._prepare()},r.prototype.onGeometryAdd=function(){this._redraw()},r.prototype.onGeometryRemove=function(){this._redraw()},r.prototype.onGeometrySymbolChange=function(){this._redraw()},r.prototype.onGeometryPositionChange=function(){this._redraw()},r.prototype.onGeometryShow=function(){this._redraw()},r.prototype.onGeometryHide=function(){this._redraw()},r.prototype.onGeometryPropertiesChange=function(t){if(t&&this.layer.getStyle())for(var e=0;e<t.length;e++)this.layer._styleGeometry(t[e])},r.prototype.hide=function(){return this._cancelAnim(),t.prototype.hide.call(this)},r.prototype._redraw=function(){this._cancelAnim(),this._needUpdate=!0,this.render()},r.prototype._animate=function(){var t=this;this.prepareCanvas(),this._drawAllMarkers(this._currentMarkers);var r=Date.now();this._animFn||(this._animFn=function(){this._animate()}.bind(this),this._startTime=r);var n=this.layer.options;if(this.getMap()&&!this.getMap().isInteracting()&&!(n.animationOnce&&r-this._startTime>n.animationDuration)){var i=this.layer.options.fps||24;i>=62.5?this._animId=e.Util.requestAnimFrame(this._animFn):this._animTimeout=setTimeout(function(){t._animFn&&(e.Browser.ie9?t._animFn():t._animId=e.Util.requestAnimFrame(t._animFn))},1e3/this.layer.options.fps)}},r.prototype._drawAllMarkers=function(t){var e=this,r=this.getMap(),n=r.getContainerExtent(),i=this._drawnTime=Date.now(),a=this._drawnAnim=this._getAnimation();this._drawnMarkers=[],t.forEach(function(t){if(t.g.isVisible()){var o=r.coordinateToContainerPoint(t.coordinates);n.contains(o)&&(e._drawMarker(t,o,a,i),e._drawnMarkers.push(t))}},this),this.requestMapToRender()},r.prototype._drawMarker=function(t,e,r,n){var i=this.layer.options.animationDuration,a=this.context,o=a.globalAlpha,s=(n-t.start)%i/i,p=r.fade&&s>=.5?2-2*s:1,c=r.scale?s:1,h=t.cacheKey,l=this._spriteCache[h],m=l.offset,f=l.canvas.width,y=l.canvas.height;l&&p>0&&(a.globalAlpha=o*p,a.drawImage(l.canvas,e.x+m.x-f*c/2,e.y+m.y-y*c/2,f*c,y*c),a.globalAlpha=o)},r.prototype._prepare=function(){var t=this,e=[],r={};this.layer.forEach(function(n){t._currentGeo=n;var i=n._getInternalSymbol()===n.options.symbol?p:n._getInternalSymbol(),a=JSON.stringify(i);r[a]||(r[a]=i),e.push({coordinates:n.getCoordinates(),cacheKey:a,start:t.layer.options.randomAnimation?Math.random()*t.layer.options.animationDuration:0,g:n})}),this._prepareSprites(r),this._currentMarkers=e},r.prototype._prepareSprites=function(t){this._spriteCache={};for(var r in t){var n=t[r],i=new e.Marker([0,0],{symbol:n})._getSprite(this.resources);this._spriteCache[r]=i}},r.prototype._cancelAnim=function(){e.Util.cancelAnimFrame(this._animId),clearTimeout(this._animTimeout)},r.prototype.onMoveStart=function(){this._cancelAnim()},r.prototype.onDragRotateStart=function(){this._cancelAnim()},r.prototype.onZoomStart=function(){this._cancelAnim()},r.prototype.onRemove=function(){this._animId&&this._cancelAnim(),delete this._animFn,delete this._spriteCache,delete this._currentMarkers,delete this._drawnMarkers},r.prototype._getAnimation=function(){for(var t={fade:!1,scale:!1},e=this.layer.options.animation?this.layer.options.animation.split(","):[],r=0;r<e.length;r++){var n=s(e[r]);"fade"===n?t.fade=!0:"scale"===n&&(t.scale=!0)}return t},r}(e.renderer.OverlayLayerCanvasRenderer)),t.AnimateMarkerLayer=h,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.animatemarker v0.1.2, requires maptalks@^0.23.0.")});