/*!
 * maptalks.animatemarker v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),n=0;n<r.length;n++){var i=r[n],o=Object.getOwnPropertyDescriptor(e,i);o&&o.configurable&&void 0===t[i]&&Object.defineProperty(t,i,o)}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}function a(t){return{type:"radial",colorStops:[[.7,"rgba("+t.join()+", 0.5)"],[.3,"rgba("+t.join()+", 1)"],[.2,"rgba("+t.join()+", 1)"],[0,"rgba("+t.join()+", 0)"]]}}var s={markerType:"ellipse",markerFill:a([135,196,240]),markerFillOpacity:.8,markerLineWidth:0,markerWidth:16,markerHeight:16},p={animation:"scale,fade",animationOnce:!1,randomAnimation:!0,animationDuration:3e3,symbol:null,fps:24},h=function(t){function r(){return n(this,r),i(this,t.apply(this,arguments))}return o(r,t),r.prototype.addGeometry=function(r){return r instanceof e.Geometry&&(r=[r]),r.forEach(function(t,r){if(!(t instanceof e.Marker))throw new Error("The geometry at "+r+" to add is not a maptalks.Marker")}),t.prototype.addGeometry.apply(this,arguments)},r.fromJSON=function(t){if(!t||"AnimateMarkerLayer"!==t.type)return null;for(var n=new r(t.id,t.options),i=t.geometries,o=[],a=0;a<i.length;a++){var s=e.Geometry.fromJSON(i[a]);s&&o.push(s)}return n.addGeometry(o),t.style&&n.setStyle(t.style),n},r}(e.VectorLayer);h.mergeOptions(p),h.registerJSONType("AnimateMarkerLayer"),h.registerRenderer("canvas",function(t){function r(){return n(this,r),i(this,t.apply(this,arguments))}return o(r,t),r.prototype.draw=function(){this._animId&&this._cancelAnim(),this._needUpdate&&(this._prepare(),this._needUpdate=!1),this._animate(),this.isLoaded()||this.completeRender()},r.prototype.onCanvasCreate=function(){this._prepare()},r.prototype.onGeometryAdd=function(){this._redraw()},r.prototype.onGeometryRemove=function(){this._redraw()},r.prototype.onGeometrySymbolChange=function(){this._redraw()},r.prototype.onGeometryPositionChange=function(){this._redraw()},r.prototype.onGeometryShow=function(){this._redraw()},r.prototype.onGeometryHide=function(){this._redraw()},r.prototype.onGeometryPropertiesChange=function(t){if(t&&this.layer.getStyle())for(var e=0;e<t.length;e++)this.layer._styleGeometry(t[e])},r.prototype.hide=function(){return this._cancelAnim(),t.prototype.hide.call(this)},r.prototype._redraw=function(){this._cancelAnim(),this._needUpdate=!0,this.render()},r.prototype._animate=function(){var t=this;this.prepareCanvas(),this._drawMarkers();var r=e.Util.now();this._animFn||(this._animFn=function(){this._animate()}.bind(this),this._startTime=r);var n=this.layer.options;if(!(this.getMap()._zooming||this.getMap()._moving||n.animationOnce&&r-this._startTime>n.animationDuration)){var i=this.layer.options.fps||24;i>=62.5?this._animId=e.Util.requestAnimFrame(this._animFn):this._animTimeout=setTimeout(function(){e.Browser.ie9?t._animFn():t._animId=e.Util.requestAnimFrame(t._animFn)},1e3/this.layer.options.fps)}},r.prototype._drawMarkers=function(){var t=this.context,r=this.getMap(),n=r.getSize(),i=new e.PointExtent(0,0,n.width,n.height),o=this._extent2D.getMin(),a=this.layer.options.animationDuration,s=e.Util.now(),p=this._getAnimation(),h=t.globalAlpha;this._currentMarkers.forEach(function(e){if(e.g.isVisible()){var r=(s-e.start)%a/a,n=p.scale?r:1,c=e.point.substract(o);if(i.contains(c)){var l=p.fade&&r>=.5?2-2*r:1,m=e.cacheKey,y=this._spriteCache[m],f=y.offset,u=y.canvas.width,d=y.canvas.height;y&&l>0&&(t.globalAlpha=h*l,t.drawImage(y.canvas,c.x+f.x-u*n/2,c.y+f.y-d*n/2,u*n,d*n),t.globalAlpha=h)}}},this),this.requestMapToRender()},r.prototype._prepare=function(){var t=this,e=this.getMap(),r=[],n={};this.layer.forEach(function(i){t._currentGeo=i;var o=i._getInternalSymbol()===i.options.symbol?s:i._getInternalSymbol(),a=e.coordinateToPoint(i.getCoordinates()),p=JSON.stringify(o);n[p]||(n[p]=o),r.push({point:a,cacheKey:p,start:t.layer.options.randomAnimation?Math.random()*t.layer.options.animationDuration:0,g:i})}),this._prepareSprites(n),this._currentMarkers=r},r.prototype._prepareSprites=function(t){this._spriteCache={};for(var r in t){var n=t[r],i=new e.Marker([0,0],{symbol:n})._getSprite(this.resources);this._spriteCache[r]=i}},r.prototype._cancelAnim=function(){e.Util.cancelAnimFrame(this._animId),clearTimeout(this._animTimeout)},r.prototype.onZoomEnd=function(){this._prepare(),e.renderer.Canvas.prototype.onZoomEnd.apply(this,arguments)},r.prototype.onRemove=function(){this._animId&&this._cancelAnim(),delete this._animFn,delete this._spriteCache,delete this._currentMarkers},r.prototype._getAnimation=function(){for(var t={fade:!1,scale:!1},r=this.layer.options.animation?this.layer.options.animation.split(","):[],n=0;n<r.length;n++){var i=e.StringUtil.trim(r[n]);"fade"===i?t.fade=!0:"scale"===i&&(t.scale=!0)}return t},r}(e.renderer.OverlayLayerCanvasRenderer)),t.AnimateMarkerLayer=h,Object.defineProperty(t,"__esModule",{value:!0})});